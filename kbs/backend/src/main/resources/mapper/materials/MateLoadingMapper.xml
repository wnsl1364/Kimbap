<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kimbap.kbs.materials.mapper.MateLoadingMapper">

    <!-- ìì¬ ì ì¬ ëŒ€ê¸° ëª©ë¡ ì „ì²´ ì¡°íšŒ (ì ì¬ì²˜ë¦¬ë˜ì§€ ì•Šì€ ìì¬ë§Œ) -->
    <select id="getAllMateLoadingWaitList" resultType="com.kimbap.kbs.materials.service.MateLoadingVO">
        SELECT 
            mi.mate_inbo_cd,
            mi.mcode,
            mi.mate_ver_cd,
            mi.wcode,
            mi.ware_ver_cd,
            mi.fcode,
            mi.fac_ver_cd,
            mi.purc_d_cd,
            mi.lot_no,
            mi.supplier_lot_no,
            mi.inbo_dt,
            mi.inbo_status,
            -- ë¶€ë¶„ ì ì¬ë¥¼ ê³ ë ¤í•œ ë‚¨ì€ ìˆ˜ëŸ‰ ê³„ì‚°
            (mi.total_qty - COALESCE(
                (SELECT SUM(ws.qty) 
                 FROM ware_stock ws 
                 WHERE ws.mate_inbo_cd = mi.mate_inbo_cd), 0
            )) as total_qty,
            mi.mname,
            mi.note,
            mi.cp_cd,
            mi.deli_dt,
            m.mate_name,
            m.mate_type,
            m.sto_con,
            m.unit,
            m.std,
            m.piece_unit,
            m.conver_qty,
            m.moqty,
            m.safe_stock,
            m.edate,
            m.corigin,
            m.is_used,
            m.regi,
            m.modi,
            m.cha_rea,
            m.reg_dt,
            f.fac_name,
            f.tel,
            f.op_status,
            f.address
        FROM mate_inbo mi
        INNER JOIN material m ON mi.mcode = m.mcode AND mi.mate_ver_cd = m.mate_ver_cd
        INNER JOIN factory f ON mi.fcode = f.fcode AND mi.fac_ver_cd = f.fac_ver_cd
        WHERE mi.inbo_status = 'c5'  -- ì…ê³ ì™„ë£Œ ìƒíƒœë§Œ (ì ì¬ ëŒ€ê¸°)
        AND f.op_status = 'r1'       -- í™œì„±í™”ëœ ê³µì¥ë§Œ
        -- ì™„ì „íˆ ì ì¬ì²˜ë¦¬ë˜ì§€ ì•Šì€ ìì¬ë§Œ (ë¶€ë¶„ ì ì¬ í¬í•¨)
        AND (mi.total_qty - COALESCE(
            (SELECT SUM(ws.qty) 
             FROM ware_stock ws 
             WHERE ws.mate_inbo_cd = mi.mate_inbo_cd), 0
        )) > 0
        ORDER BY mi.inbo_dt DESC, mi.mate_inbo_cd DESC
    </select>

    <!-- íŠ¹ì • ì…ê³ ë²ˆí˜¸ì˜ ì ì¬ ëŒ€ê¸° ìì¬ ë‹¨ê±´ ì¡°íšŒ -->
    <select id="getMateLoadingByInboCd" parameterType="string" resultType="com.kimbap.kbs.materials.service.MateLoadingVO">
        SELECT 
            mi.mate_inbo_cd,
            mi.mcode,
            mi.mate_ver_cd,
            mi.wcode,
            mi.ware_ver_cd,
            mi.fcode,
            mi.fac_ver_cd,
            mi.purc_d_cd,
            mi.lot_no,
            mi.supplier_lot_no,
            mi.inbo_dt,
            mi.inbo_status,
            mi.total_qty,
            mi.mname,
            mi.note,
            mi.cp_cd,
            mi.deli_dt,
            m.mate_name,
            m.mate_type,
            m.sto_con,
            m.unit,
            m.std,
            m.piece_unit,
            m.conver_qty,
            m.moqty,
            m.safe_stock,
            m.edate,
            m.corigin,
            m.is_used,
            m.regi,
            m.modi,
            m.cha_rea,
            m.reg_dt,
            f.fac_name,
            f.tel,
            f.op_status,
            f.address
        FROM mate_inbo mi
        INNER JOIN material m ON mi.mcode = m.mcode AND mi.mate_ver_cd = m.mate_ver_cd
        INNER JOIN factory f ON mi.fcode = f.fcode AND mi.fac_ver_cd = f.fac_ver_cd
        WHERE mi.mate_inbo_cd = #{mateInboCd}
        AND mi.inbo_status = 'c5'    -- ì…ê³ ì™„ë£Œ ìƒíƒœë§Œ
        AND f.op_status = 'r1'       -- í™œì„±í™”ëœ ê³µì¥ë§Œ
        AND m.is_used = 'f1'         -- í™œì„±í™”ëœ ìì¬ë§Œ
    </select>

    <!-- ìì¬ ì ì¬ ì²˜ë¦¬ (ware_stock í…Œì´ë¸”ì— INSERT) -->
    <insert id="insertWareStock" parameterType="com.kimbap.kbs.materials.service.MateLoadingVO">
        <!-- ë””ë²„ê·¸: ì‹¤í–‰ ì „ íŒŒë¼ë¯¸í„° í™•ì¸ -->
        INSERT INTO ware_stock (
            wslcode,
            ware_area_cd,
            mate_inbo_cd,
            prod_inbo_cd,
            item_type,
            inbo_dt,
            regi,
            qty,
            unit
        ) VALUES (
            #{wslcode},
            #{wareAreaCd},
            #{mateInboCd},
            NULL,                    -- ì œí’ˆì…ê³ ì½”ë“œëŠ” NULL (ìì¬ì´ë¯€ë¡œ)
            #{itemType},             -- ìì¬íƒ€ì…ì— ë”°ë¼ ë™ì  ì„¤ì •
            #{inboDt},
            #{regi},
            #{qty},
            #{unit}
        )
    </insert>

    <!-- í™œì„±í™”ëœ ê³µì¥ ëª©ë¡ ì¡°íšŒ (ë“œë¡­ë‹¤ìš´ìš©) -->
    <select id="getActiveFactoryList" resultType="com.kimbap.kbs.materials.service.MateLoadingVO">
        SELECT 
            f.fcode,
            f.fac_ver_cd,
            f.fac_name,
            f.address,
            f.tel,
            f.mname,
            f.op_status,
            f.cha_rea,
            f.reg_dt,
            f.note,
            f.regi,
            f.modi
        FROM factory f
        WHERE f.op_status = 'r1'     -- í™œì„±í™”ëœ ê³µì¥ë§Œ
        ORDER BY f.fac_name ASC
    </select>
    
        <!-- íŠ¹ì • ê³µì¥ì˜ ì°½ê³  ëª©ë¡ ì¡°íšŒ -->
    <select id="getWarehousesByFactory" parameterType="string" resultType="com.kimbap.kbs.materials.service.MateLoadingVO">
        SELECT 
            w.wcode,
            w.ware_ver_cd,
            w.ware_name,
            w.ware_type,
            w.address,
            w.max_row,
            w.max_col,
            w.max_floor,
            w.is_used,
            w.fcode,
            w.fac_ver_cd,
            w.note
        FROM warehouse w
        WHERE w.fcode = #{fcode}
        AND w.is_used = 'f1'    -- í™œì„±í™”ëœ ì°½ê³ ë§Œ
        ORDER BY w.ware_type ASC, w.ware_name ASC
    </select>
    
    <!-- íŠ¹ì • ì°½ê³ ì˜ êµ¬ì—­ ì •ë³´ ì¡°íšŒ (ì¸µë³„) -->
    <select id="getWarehouseAreasByFloor" resultType="com.kimbap.kbs.materials.service.MateLoadingVO">
        SELECT 
            wd.ware_area_cd,
            wd.area_row,
            wd.area_col,
            wd.area_floor,
            wd.vol,
            wd.is_used,
            wd.wcode,
            wd.ware_ver_cd
        FROM ware_d wd
        WHERE wd.wcode = #{wcode}
        AND wd.area_floor = #{floor}
        AND wd.is_used = 'f1'    -- í™œì„±í™”ëœ êµ¬ì—­ë§Œ
        ORDER BY wd.area_row ASC, wd.area_col ASC
    </select>
    
    <!-- êµ¬ì—­ë³„ í˜„ì¬ ì ì¬ ìƒí™© ì¡°íšŒ -->
    <select id="getWarehouseAreaStock" parameterType="string" resultType="com.kimbap.kbs.materials.service.MateLoadingVO">
        SELECT 
            ws.wslcode,
            ws.ware_area_cd,
            ws.mate_inbo_cd,
            ws.item_type,
            ws.inbo_dt,
            ws.regi,
            ws.qty,
            ws.unit,
            mi.mcode,
            m.mate_name
        FROM ware_stock ws
        LEFT JOIN mate_inbo mi ON ws.mate_inbo_cd = mi.mate_inbo_cd
        LEFT JOIN material m ON mi.mcode = m.mcode AND mi.mate_ver_cd = m.mate_ver_cd
        WHERE ws.ware_area_cd = #{wareAreaCd}
        ORDER BY ws.inbo_dt DESC
    </select>
    
    <!-- ì°½ê³ êµ¬ì—­ì½”ë“œ ì¡°íšŒ -->
    <select id="getWareAreaCode" resultType="string">
        SELECT ware_area_cd
        FROM ware_d
        WHERE wcode = #{wcode}
        AND area_row = #{areaRow}
        AND area_col = #{areaCol}
        AND area_floor = #{areaFloor}
        AND is_used = 'f1'
    </select>
    
    <!-- ì°½ê³ ì¬ê³ ëª©ë¡ì½”ë“œ ë§ˆì§€ë§‰ ìˆœë²ˆ ì¡°íšŒ -->
    <select id="getLastWareStockSequence" parameterType="string" resultType="int">
        SELECT COALESCE(MAX(TO_NUMBER(SUBSTR(wslcode, -3))), 0) as last_seq
        FROM ware_stock
        WHERE wslcode LIKE 'WStock-' || #{datePattern} || '-%'
    </select>
    
    <!-- êµ¬ì—­ë³„ í˜„ì¬ ì ì¬ëŸ‰ í•©ê³„ ì¡°íšŒ -->
    <select id="getCurrentVolumeByArea" parameterType="string" resultType="int">
        SELECT COALESCE(SUM(qty), 0) as current_volume
        FROM ware_stock
        WHERE ware_area_cd = #{wareAreaCd}
    </select>
    
    <!-- êµ¬ì—­ì— ì ì¬ëœ ìì¬ì½”ë“œ ì¡°íšŒ -->
    <select id="getCurrentMaterialByArea" parameterType="string" resultType="string">
        SELECT DISTINCT mi.mcode
        FROM ware_stock ws
        INNER JOIN mate_inbo mi ON ws.mate_inbo_cd = mi.mate_inbo_cd
        WHERE ws.ware_area_cd = #{wareAreaCd}
        AND ROWNUM = 1  -- ì²« ë²ˆì§¸ ìì¬ì½”ë“œë§Œ ë°˜í™˜
    </select>
    
    <!-- ë™ì¼í•œ ìì¬ê°€ ì ì¬ëœ ë‹¤ë¥¸ êµ¬ì—­ë“¤ ì¡°íšŒ -->
    <select id="getSameMaterialAreas" resultType="com.kimbap.kbs.materials.service.MateLoadingVO">
        SELECT DISTINCT
            ws.ware_area_cd,
            wd.area_row,
            wd.area_col,
            wd.area_floor,
            wd.vol,
            NVL(area_stock.current_volume, 0) as current_volume,
            (wd.vol - NVL(area_stock.current_volume, 0)) as available_volume
        FROM ware_stock ws
        INNER JOIN mate_inbo mi ON ws.mate_inbo_cd = mi.mate_inbo_cd
        INNER JOIN ware_d wd ON ws.ware_area_cd = wd.ware_area_cd
        INNER JOIN warehouse w ON wd.wcode = w.wcode AND wd.ware_ver_cd = w.ware_ver_cd
        LEFT JOIN (
            SELECT ware_area_cd, SUM(qty) as current_volume
            FROM ware_stock
            GROUP BY ware_area_cd
        ) area_stock ON ws.ware_area_cd = area_stock.ware_area_cd
        WHERE mi.mcode = #{mcode}
        AND w.fcode = #{fcode}
        AND ws.ware_area_cd != #{excludeAreaCd}
        AND (wd.vol - NVL(area_stock.current_volume, 0)) > 0  -- ì”ì—¬ ìš©ëŸ‰ì´ ìˆëŠ” ê³³ë§Œ
        ORDER BY available_volume DESC
    </select>
    
    <!-- ğŸ”¥ material í…Œì´ë¸”ì—ì„œ ìì¬ ì •ë³´ ì¡°íšŒ -->
    <select id="getMaterialInfo" parameterType="string" resultType="com.kimbap.kbs.materials.service.MateLoadingVO">
        SELECT 
            mcode,
            mate_name,
            mate_type,
            sto_con,
            unit,
            std,
            piece_unit,
            conver_qty,
            moqty,
            safe_stock,
            is_used
        FROM material
        WHERE mcode = #{mcode}
        AND is_used = 'f1'
    </select>
</mapper>