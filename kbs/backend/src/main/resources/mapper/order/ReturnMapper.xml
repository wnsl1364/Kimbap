<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kimbap.kbs.order.mapper.ReturnMapper">

  <!-- 반품 등록 -->
  <insert id="insertReturnItem" parameterType="com.kimbap.kbs.order.service.ReturnItemVO">
    INSERT INTO prod_return (
      prod_return_cd,
      ord_d_cd,
      lot_no,
      return_dt,
      return_qty,
      return_amount,
      return_rea,
      return_status_customer
    )
    VALUES (
      #{prodReturnCd},
      #{ordDCd},
      #{lotNo},
      #{returnDt},
      #{returnQty},
      #{returnAmount},
      #{returnRea},
      #{returnStatusCustomer}
    )
  </insert>

  <!-- 반품코드 시퀀스 조회 -->
  <select id="getNextReturnCodeSeq" resultType="int">
      SELECT SEQ_PROD_RETURN.NEXTVAL FROM dual
  </select>

  <!-- 주문 상세 상태 변경 → 't4' (반품요청) -->
  <update id="updateOrderDetailStatus" parameterType="string">
    UPDATE order_d
    SET ord_d_status = 't4'
    WHERE ord_d_cd = #{ordDCd}
  </update>

  <!-- 반품 이력 조회 -->
  <select id="getReturnHistoryByOrdCd" resultType="com.kimbap.kbs.order.service.ReturnItemVO">
    SELECT
      pr.prod_return_cd AS prodReturnCd,
      pr.ord_d_cd AS ordDCd,
      pr.lot_no AS lotNo,
      pr.return_dt AS returnDt,
      pr.return_qty AS returnQty,
      pr.return_amount AS returnAmount,
      pr.return_rea AS returnRea,
      pr.return_status_customer AS returnStatusCustomer
    FROM prod_return pr
    JOIN order_d od ON pr.ord_d_cd = od.ord_d_cd
    WHERE od.ord_cd = #{ordCd}
  </select>

  <!-- 주문 상세 전체 건수 조회 -->
  <select id="getOrderDetailCount" parameterType="string" resultType="int">
      SELECT COUNT(*) FROM order_d WHERE ord_cd = #{ordCd} AND is_used = 'f1'
  </select>

  <!-- 주문 상세 중 특정 상태 건수 조회 -->
  <select id="getOrderDetailStatusCount" parameterType="map" resultType="int">
      SELECT COUNT(*) FROM order_d
      WHERE ord_cd = #{ordCd} AND ord_d_status = #{status} AND is_used = 'f1'
  </select>

  <!-- 주문 마스터 상태 업데이트 (동적 상태 적용) -->
  <update id="updateOrderStatusCustomer" parameterType="map">
      UPDATE order_list
      SET ord_status_customer = #{status}
      WHERE ord_cd = #{ordCd}
        AND is_used = 'f1'
  </update>

  <!-- 반품목록조회 -->
  <resultMap id="ReturnListMap" type="com.kimbap.kbs.order.service.ReturnItemVO">
    <result column="PRODRETURNCD" property="prodReturnCd"/>
    <result column="RETURNDT" property="returnDt"/>
    <result column="CPNAME" property="cpName"/>
    <result column="PRODNAME" property="prodName"/>
    <result column="RETURNQTY" property="returnQty"/>
    <result column="RETURNREA" property="returnRea"/>
    <result column="REJECTREA" property="rejectRea"/>
    <result column="RETURNSTATUSINTERNAL" property="returnStatusInternal"/>
    <result column="RETURNENDDT" property="returnEndDt"/>
    <result column="MANAGERNAME" property="managerName"/>
  </resultMap>
  <select id="getReturnList" parameterType="map" resultMap="ReturnListMap">
    SELECT *
    FROM vw_return_list
    WHERE 1=1
      <if test="cpName != null and cpName != ''">
        AND CPNAME LIKE '%' || #{cpName} || '%'
      </if>
      <if test="returnStatusInternal != null and returnStatusInternal != ''">
        AND RETURNSTATUSINTERNAL = #{returnStatusInternal}
      </if>
      <if test="prodName != null and prodName != ''">
        AND PRODNAME LIKE '%' || #{prodName} || '%'
      </if>
      <if test="startDate != null and startDate != ''">
        AND TRUNC(RETURNDT) &gt;= TO_DATE(#{startDate}, 'YYYY-MM-DD')
      </if>
      <if test="endDate != null and endDate != ''">
        AND TRUNC(RETURNDT) &lt;= TO_DATE(#{endDate}, 'YYYY-MM-DD')
      </if>
    ORDER BY PRODRETURNCD
  </select>

  <!-- 반품 상태 업데이트 -->
  <update id="updateReturnStatus">
      UPDATE prod_return
      SET 
          return_status_internal = #{returnStatusInternal},
          manager = #{manager},
          return_end_dt = SYSDATE,
          reject_rea = 
              CASE WHEN #{returnStatusInternal} = 'w2' THEN #{rejectRea} 
                  ELSE reject_rea END
      WHERE prod_return_cd = #{prodReturnCd}
  </update>


  <!-- 주문상세 상태 변경 -->
  <update id="updateOrderDetailStatusToT5" parameterType="string">
    UPDATE order_d
    SET ord_d_status = 't5'
    WHERE ord_d_cd = (SELECT ord_d_cd FROM prod_return WHERE prod_return_cd = #{prodReturnCd})
  </update>

  <!-- 주문상세 상태를 t1(주문접수)로 복구 -->
  <update id="updateOrderDetailStatusToT1" parameterType="string">
    UPDATE order_d
    SET ord_d_status = 't1'
    WHERE ord_d_cd = (
      SELECT ord_d_cd FROM prod_return WHERE prod_return_cd = #{prodReturnCd}
    )
  </update>

  <!-- prod_return_cd를 통해 ord_cd 조회 -->
  <select id="getOrdCdByReturnCd" parameterType="string" resultType="string">
    SELECT od.ord_cd
    FROM order_d od
    JOIN prod_return pr ON od.ord_d_cd = pr.ord_d_cd
    WHERE pr.prod_return_cd = #{prodReturnCd}
  </select>

  <!-- lot번호 -->
  <select id="getLotNoByOrdDCd" parameterType="string" resultType="string">
      SELECT pr.lot_no
      FROM prod_rel pr
      JOIN release_ord ro ON pr.rel_ord_cd = ro.rel_ord_cd
      WHERE ro.ord_d_cd = #{ordDCd}
  </select>
</mapper>