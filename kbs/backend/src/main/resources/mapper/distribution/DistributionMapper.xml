<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kimbap.kbs.distribution.mapper.DistributionMapper">

  <!-- 입출고 조회 페이지 -->
  <select id="getInOutCheck" resultType="com.kimbap.kbs.distribution.service.DistributionVO" parameterType="com.kimbap.kbs.distribution.service.DistributionVO">
    SELECT
      temp.regDt,
      temp.type,
      temp.pCode,
      temp.prodName,
      temp.qty,
      temp.wareAreaCd,
      temp.stockQty,
      temp.note
    FROM (
      SELECT 
        a.inbo_dt AS regDt,
        '입고' AS type,
        a.pcode,
        b.prod_name AS prodName,
        a.inbo_qty AS qty,
        '' AS note,
        c.ware_area_cd AS wareAreaCd,
        c.qty AS stockQty
      FROM prod_inbo a
      JOIN product b ON a.pcode = b.pcode
      JOIN ware_stock c ON a.prod_inbo_cd = c.prod_inbo_cd

      UNION ALL

      SELECT 
        a.rel_dt AS regDt,
        '출고' AS type,
        b.pcode,
        b.prod_name AS prodName,
        a.rel_qty AS qty,
        d.note,
        e.ware_area_cd AS wareAreaCd,
        e.qty AS stockQty
      FROM prod_rel a
      JOIN product b ON a.pcode = b.pcode
      JOIN release_ord d ON a.rel_ord_cd = d.rel_ord_cd
      JOIN prod_inbo f ON a.lot_no = f.lot_no
      JOIN ware_stock e ON f.prod_inbo_cd = e.prod_inbo_cd
    ) temp

<where>
  <if test="prodName != null and prodName != ''">
    AND temp.prodName LIKE '%' || #{prodName} || '%'
  </if>
  <if test="pCode != null and pCode != ''">
  AND temp.pCode LIKE '%' || #{pCode} || '%'
</if>
<if test="wareAreaCd != null and wareAreaCd != ''">
  AND temp.wareAreaCd LIKE '%' || #{wareAreaCd} || '%'
</if>

  <if test="type != null and type != '전체'">
    AND temp.type = #{type}
  </if>
  <if test="startDate != null and endDate != null">
    AND temp.regDt BETWEEN #{startDate} AND #{endDate}
  </if>
</where>


    ORDER BY temp.regDt DESC
  </select>

  <!-- 출고지시서 조회 -->
  <select id="getRelOrdList" resultType="com.kimbap.kbs.distribution.service.RelOrderAndResultVO" parameterType="com.kimbap.kbs.distribution.service.RelOrderAndResultVO">
  SELECT 
    a.rel_ord_cd,
    a.rel_dt,
    d.cp_name,
    e.prod_name,
    a.rel_ord_qty,
    c.deli_add,
    a.rel_ord_status,
    a.note
  FROM release_ord a
  JOIN order_d b ON a.ord_d_cd = b.ord_d_cd
  JOIN order_list c ON c.ord_cd = b.ord_cd
  JOIN company d ON d.cp_cd = c.cp_cd
  JOIN product e ON e.pcode = b.pcode
  <where>
    <if test="cpName != null and cpName != ''">
      AND d.cp_name LIKE '%' || #{cpName} || '%'
    </if>
    <if test="relOrdCd != null and relOrdCd != ''">
      AND a.rel_ord_cd LIKE '%' || #{relOrdCd} || '%'
    </if>
    <if test="type != null and type != '전체'">
      AND a.rel_ord_status = #{type}
    </if>
    <if test="startDate != null and endDate != null">
      AND a.rel_dt BETWEEN #{startDate} AND #{endDate}
    </if>
  </where>
</select>

<!-- 출고지시서 모달 출력 -->
<select id="getRelOrdModal" resultType="com.kimbap.kbs.distribution.service.RelOrdModalVO" parameterType="com.kimbap.kbs.distribution.service.RelOrdModalVO">
  SELECT
      o.ord_cd AS ordCd,
      c.cp_name AS cpName,
      (
          SELECT 
              MIN(p.prod_name) || CASE 
                  WHEN COUNT(*) = 1 THEN ''
                  ELSE ' 외 ' || (COUNT(*) - 1) || '개'
              END
          FROM order_d od2
          JOIN product p ON od2.pcode = p.pcode AND od2.prod_ver_cd = p.prod_ver_cd
          WHERE od2.ord_cd = o.ord_cd
      ) AS prodNameSummary,
      o.ord_dt AS ordDt
  FROM order_list o
  JOIN company c ON o.cp_cd = c.cp_cd

  WHERE o.is_used = 'f1'
    AND EXISTS (
      SELECT 1
      FROM order_d od
      JOIN prod_inbo pi ON od.pcode = pi.pcode AND od.prod_ver_cd = pi.prod_ver_cd
      WHERE od.ord_cd = o.ord_cd
    )
  ORDER BY o.ord_dt DESC
</select>

<!-- 출고지시서 모달 선택시 출력 -->
<select id="getRelOrdSelect" resultType="com.kimbap.kbs.distribution.service.RelOrdModalVO" parameterType="String">
SELECT
(
        SELECT 
            'REL-' || TO_CHAR(SYSDATE, 'YYYYMMDD') || '-' ||
            LPAD(NVL(MAX(SUBSTR(rel_ord_cd, -4)), 0) + 1, 4, '0')
        FROM release_ord
        WHERE TO_CHAR(rel_dt, 'YYYYMMDD') = TO_CHAR(SYSDATE, 'YYYYMMDD')
    ) AS newRelOrdCd,

    p.prod_name AS prodName,
    od.ord_qty AS ordQty,
    od.pcode AS pCode,
    od.prod_ver_cd AS prodVerCd,
    cp.cp_name AS mCpName,
    cp.mname AS mName,

    NVL((
        SELECT SUM(pr.rel_qty)
        FROM prod_rel pr
        JOIN release_ord ro ON pr.rel_ord_cd = ro.rel_ord_cd
        WHERE ro.ord_d_cd = od.ord_d_cd
    ), 0) AS relQty,

    (od.ord_qty - NVL((
        SELECT SUM(pr.rel_qty)
        FROM prod_rel pr
        JOIN release_ord ro ON pr.rel_ord_cd = ro.rel_ord_cd
        WHERE ro.ord_d_cd = od.ord_d_cd
    ), 0)) AS noRelQty,

    CASE
        WHEN NVL((
            SELECT SUM(pr.rel_qty)
            FROM prod_rel pr
            JOIN release_ord ro ON pr.rel_ord_cd = ro.rel_ord_cd
            WHERE ro.ord_d_cd = od.ord_d_cd
        ), 0) = 0 THEN '미출고'
        WHEN NVL((
            SELECT SUM(pr.rel_qty)
            FROM prod_rel pr
            JOIN release_ord ro ON pr.rel_ord_cd = ro.rel_ord_cd
            WHERE ro.ord_d_cd = od.ord_d_cd
        ), 0) &lt; od.ord_qty THEN '부분출고'
        ELSE '출고완료'
    END AS relOrdStatus

FROM order_d od
JOIN product p 
  ON od.pcode = p.pcode 
 AND od.prod_ver_cd = p.prod_ver_cd
JOIN order_list odl
  ON od.ord_cd = odl.ord_cd
JOIN company cp
  ON odl.cp_cd = cp.cp_cd

WHERE od.ord_cd = #{ordCd}
</select>

<!-- 창고출력 select -->
<select id="getWarehouseListByOrdCd" resultType="com.kimbap.kbs.distribution.service.WarehouseVO" parameterType="String">
SELECT DISTINCT
  f.wcode,
  f.ware_name
FROM order_d a
JOIN product b
  ON a.pcode = b.pcode
 AND a.prod_ver_cd = b.prod_ver_cd
JOIN prod_inbo c
  ON b.pcode = c.pcode
 AND b.prod_ver_cd = c.prod_ver_cd
JOIN ware_stock d
  ON d.prod_inbo_cd = c.prod_inbo_cd
JOIN ware_d e
  ON e.ware_area_cd = d.ware_area_cd
JOIN warehouse f
  ON f.wcode = e.wcode
WHERE a.ord_cd = #{ordCd}
</select>

</mapper>